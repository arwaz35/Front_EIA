import React, { useState, useEffect, useRef } from "react";
import Head from "next/head";
import Image from "next/image";
import styles from "../styles/Home.module.css";
import SideMenu from "../components/sideMenu";
import Header from "../components/Header";
import Graph from "../components/Graph";
import RTGraph from "../components/RTGraph";
import { GiElectric } from "react-icons/gi";

var mqtt = require("mqtt");
var options = {
  protocol: "mqtts",
  clientId: "User1",
  username: "daniel-eia",
  password: "PfB28Q6QswPRw9iY",
};

var cont = 0;
var flag_kill = 0;

export default function Dashboard({ data }) {
  const [current_val, setcurrent] = useState("");

  //REal time graph
  const [current_graph, setcurrent_graph] = useState([{ id: 0, value: 0 }]);

  let currentref = useRef("");
  currentref.current = current_val;
  useEffect(() => {
    var client = mqtt.connect("mqtt://daniel-eia.cloud.shiftr.io", options);
    client.subscribe("compresor1/Corriente/Fase");
    var note;
    client.on("message", function (topic, message) {
      note = message.toString();
      cont = cont + 1;
      setcurrent_graph((current_graph) => [
        ...current_graph,
        { id: cont, value: note },
      ]);
      setcurrent(note);
      if (currentref.current === "" && flag_kill === 0) {
        client.end();
        flag_kill = 1;
      }
    });
  }, []);
  return (
    <div className={styles.container}>
      <Head>
        <title>IOT EIA</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <main className={styles.main}>
        <Header></Header>
        <SideMenu></SideMenu>

        <Graph data={data["list_1"]} data_1={data["list_2"]}></Graph>
        <RTGraph data={current_graph}></RTGraph>

        <div className={styles.container_widgets}>
          <div className={styles.widget}>
            <div className={styles.tittle_widget}>CORRIENTE</div>
            <div className={styles.row_widget}>
              <GiElectric
                className="icon_bar"
                style={{ fontSize: "100px" }}
              ></GiElectric>
              <div className={styles.tittle_widget}>{current_val}</div>
            </div>
          </div>
          <div className={styles.widget}></div>
        </div>

        {/* <div className={styles.title}>DASHBOARD</div> */}
      </main>
      <div></div>
    </div>
  );
}

export const getServerSideProps = async () => {
  const apiResponse = await fetch("http://172.20.10.7:8000/api/get_dots/1/");
  const data = await apiResponse.json();
  return { props: { data } };
};
